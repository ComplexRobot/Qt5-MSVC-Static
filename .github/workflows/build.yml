name: Build

on:
  push:
    branches: [ workflow-5.15.16 ]

jobs:
  build:
    runs-on: windows-latest

    env:
      SET_VC_VARS: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64
      PREFIX: ${{ github.workspace }}\Qt

    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: workflow-5.15.16
      - name: Build Script
        run: |
          call "%SET_VC_VARS%"
          cd "${{ github.event.repository.name }}"
          call qt download
          call qt openssl
          call qt setup
          call qt build
      - name: 7z Compress
        id: zip
        run: |
          call "${{ github.event.repository.name }}\tools\options"
          7z a -mx -m0=LZMA2 -ms=on -mmt=on msvc%MSVCVER%-%VSCMD_ARG_TGT_ARCH%-static.7z %PREFIX%\%QTVER%\
          echo "zip-file-path=%CD%\msvc%MSVCVER%-%VSCMD_ARG_TGT_ARCH%-static.7z" >> "%GITHUB_OUTPUT%"
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.zip.outputs.zip-file-path }}
          tag_name: qt5.15.16
          body: 'Statically linked Qt5.15.16'
          target_commitish: workflow-5.15.16
          fail_on_unmatched_files: true